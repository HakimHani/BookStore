<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
	<link href="css/admins.css" rel="stylesheet" />
</head>
<body>

	<center><h3>All Products</h3></center>
	<button type="button" onclick="doAdminsAjax('/api/iteminfo/', 'populate_products_handler');">show products</button>
    <div align = "center" id="products_table" class="products" style="border:'1'; cellpadding:'5';">
    </div>

</body>
</html>

<script>

// generate a report with the books sold each month
var domain = "http://localhost:8090";

function doAjax(address){
	 var request = new XMLHttpRequest();
	 var month = document.getElementById("monthlyReport").value;
	 var url = "./api/checkout/" + month;
	 request.onreadystatechange = function() {
			handler(request);
	 };
	 request.open("GET", url, true);
	 request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	 request.send(); 
} 

function handler(request){
	 if ((request.readyState == 4) && (request.status == 200))
	 {
		 var target = document.getElementById("result");
		 target.innerHTML = request.responseText;
	 }
}

//provide real time analytics (Listeners) with most popular products (life time), like â€œtop 10 sold books
function getBooksStats(){
	var request = new XMLHttpRequest();
	url = "./api/"
	request.onreadystatechange = function(){
		handlerBooksStats(request);
	 };
	 request.open("GEt", ulr, true);
	 request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	 request.send(data); 	
}

function handlerBooksStats(request){
	 if ((request.readyState == 4) && (request.status == 200))
	 {
		 var target = document.getElementById("result");
		 var result =  JSON.parse(request.responseText);
		 var table = buildTable(result);
		 table.border = '1';
		 target.innerHTML = "";
		 target.appendChild(table);
	 }
}

function buildTable(result){
	var table = document.createElement("TABLE");
	table.setAttribute("id", "myTable");
 var row = document.createElement("TR");
 var data = document.createElement("TD");
 data.innerHTML = "Book Title";
 row.appendChild(data);
 
 data = document.createElement("TD");
 data.innerHTML = "Book Id";
 row.appendChild(data);
 
 table.appendChild(row);
 
 var i=0;
 for (i=0; i<result.length; i++){
 	
	    row = document.createElement("TR");
	    
	    data = document.createElement("TD");
	    data.innerHTML =result[i].username;
	    row.appendChild(data);
	    
	    data = document.createElement("TD");
	    data.innerHTML = result[i];
	    row.appendChild(data);
	    
	    table.appendChild(row);
 }
 
 return table;
}

// admins ops
function doAdminsAjax(path, handler){
	 var request = new XMLHttpRequest();
	 request.onreadystatechange = function() {
		 if(handler == "populate_products_handler"){
			populate_products_handler(request);
		 } else if(handler == "Edit")
			 Edit(request);
		 
	 };
	 request.open("GET", domain + path, true);
	 request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
	 request.send(); 
} 

function doAdminsAjaxPost(path, id, handler){
	const data = JSON.stringify({
		  productId: id
		})
	 var request = new XMLHttpRequest();
	 request.onreadystatechange = function() {
		 if(handler == "populate_products_handler"){
			populate_products_handler(request);
		 } else if(handler == "Edit")
			 Edit(request);
		 else if(handler == "deleted")
			 deleted(request);
		 
	 };
	 request.open("POST", domain + path);
	 request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
	 request.send(data); 
} 

function populate_products_handler(request){
	 if ((request.readyState == 4) && (request.status == 200)) {
		 var target = document.getElementById("products_table");
		 var products = JSON.parse(request.responseText)
		 var table = "";
		 table += '<table>';
		 table += "<tr>";
		 table += "<td>Id</td>";
		 table += "<td>Product</td>";
		 table += "<td>Category</td>";
		 table += "<td>Price</td>";
		 table +="</tr>";
		 
		 for (var product of products) {
			 table += "<tr>";
			 table +="<td>" + product.productId + "</td>";
			 table +="<td>" + product.itemName + "</td>";
			 table +="<td>" + product.category + "</td>";
			 table += "<td>" + product.price + "</td>";
			 table += '<td><button onclick="showProduct(\'' + product.productId + '\' );">' + "Show" + "</a></td>"; 
			 table += '<td><button onclick="editProduct(\'' + product.productId + '\' );">' + "Edit" + "</a></td>"; 
			 table += '<td><button onclick="deleteProduct(\'' + product.productId + '\' );">' + "Delete" + "</a></td>"; 
			 table += "</tr>"
		 }
		 target.innerHTML = table;
	 }
}

function showProduct(id){
	console.log(id);
}

function editProduct(id){
	doAdminsAjax('/api/iteminfo/' + id + "", "Edit")
}

function deleteProduct(id){
	doAdminsAjaxPost('/api/iteminfo/delete', id, "deleted")
}

function Edit(request){
	console.log(request.responseText);
}

function deleted(request){
	if ((request.readyState == 4) && (request.status == 200)) {
		doAdminsAjax("/api/itemInfo", "populate_products_handler");
	}
	
}

</script>

